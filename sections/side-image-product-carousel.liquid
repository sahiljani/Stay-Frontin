{% comment %}
  Side Image + Product Carousel Section
  Allows merchant to select an image on the left and multiple product blocks that render in a horizontal scroll carousel.
{% endcomment %}

<section id="section-{{ section.id }}" class="side-image-product-carousel" data-section-id="{{ section.id }}">
  <div class="container">
    {% if section.settings.heading != blank %}
      <h2 class="section-heading">{{ section.settings.heading }}</h2>
    {% endif %}
    <div class="layout">
      <div class="side-image-wrapper">
        {% if section.settings.side_image != blank %}
          {%- liquid
            assign side_image = section.settings.side_image | image_url: width: 800
          -%}
          <div class="side-image-ratio">
            <img
              src="{{ side_image }}"
              alt="{{ section.settings.side_image.alt | escape }}"
              loading="lazy"
              width="{{ section.settings.side_image.width }}"
              height="{{ section.settings.side_image.height }}" />
          </div>
        {% else %}
          <div class="placeholder">{{ 'image' | placeholder_svg_tag }}</div>
        {% endif %}
      </div>

      <div class="carousel-outer">
  <div class="embla" id="carousel-{{ section.id }}" aria-label="Product carousel" data-embla-init data-section-id="{{ section.id }}" data-scroll-cards="{{ section.settings.scroll_cards | default: 2 }}">
          <div class="embla__viewport">
            <div class="embla__container">
              {% for block in section.blocks %}
                {% if block.type == 'product' and block.settings.product != blank %}
                  {%- assign product = all_products[block.settings.product] -%}
                  {% if product %}
                    <div class="card embla__slide" {{ block.shopify_attributes }}>
                      <a href="{{ product.url }}" class="card-image-wrapper">
                        {%- if product.featured_image -%}
                          <img src="{{ product.featured_image | image_url: width: 600 }}" alt="{{ product.featured_image.alt | escape }}" loading="lazy" width="{{ product.featured_image.width }}" height="{{ product.featured_image.height }}" />
                        {%- else -%}
                          <div class="placeholder small">{{ 'product' | placeholder_svg_tag }}</div>
                        {%- endif -%}
                      </a>
                      <div class="card-info">
                        {% if section.settings.show_vendor and product.vendor != blank %}
                          <p class="vendor">{{ product.vendor }}</p>
                        {% endif %}
                        <h3 class="title"><a href="{{ product.url }}">{{ product.title }}</a></h3>
                        <div class="price-wrapper">
                          {% render 'price', product: product %}
                        </div>
                        {% if product.available %}
                          <form method="post" action="/cart/add" class="add-form" data-product-id="{{ product.id }}">
                            <input type="hidden" name="id" value="{{ product.selected_or_first_available_variant.id }}" />
                            <button type="submit" class="add-btn" aria-label="Add {{ product.title }} to cart">{{ section.settings.add_to_cart_label }}</button>
                          </form>
                        {% else %}
                          <p class="sold-out">{{ section.settings.sold_out_label }}</p>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                {% endif %}
              {% endfor %}
            </div>
          </div>
          <button type="button" class="nav prev" aria-label="Previous" id="prev-{{ section.id }}" disabled>&#10094;</button>
          <button type="button" class="nav next" aria-label="Next" id="next-{{ section.id }}" disabled>&#10095;</button>
        </div>
      </div>
    </div>
  </div>

  <style>
    #section-{{ section.id }} {
      background: {{ section.settings.background_color }};
      padding: {{ section.settings.padding_vertical_percent }}% 0;
    }
    #section-{{ section.id }} .container { max-width: 1300px; margin: 0 auto; padding: 0 1.5rem; }
    #section-{{ section.id }} .section-heading { text-align:center; font-weight:700; margin-bottom: 2.5rem; letter-spacing: .08em; }
    #section-{{ section.id }} .layout { display:flex; gap: clamp(1rem, 2vw, 2.5rem); align-items: stretch; min-height: 400px; }
    #section-{{ section.id }} .side-image-wrapper { flex: 0 0 {{ section.settings.image_width_percent }}%; position:relative; min-width: 200px; }
    #section-{{ section.id }} .side-image-ratio { aspect-ratio: 3/4; overflow:hidden; border-radius: 12px; }
    #section-{{ section.id }} .side-image-ratio img { width:100%; height:100%; object-fit:cover; display:block; }
    #section-{{ section.id }} .placeholder { width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:#f3f3f3; border-radius:12px; aspect-ratio: 3/4; }
    #section-{{ section.id }} .placeholder svg { width: 64px; height: 64px; opacity: 0.5; }
  #section-{{ section.id }} .carousel-outer { position:relative; flex:1; margin-left: calc(-1 * {{ section.settings.carousel_overlap_x }}px); margin-top: {{ section.settings.carousel_overlap_y }}px; }
  #section-{{ section.id }} .embla { position:relative; }
  #section-{{ section.id }} .embla__viewport { overflow:hidden; width:100%; cursor: grab; }
  #section-{{ section.id }} .embla__viewport:active { cursor: grabbing; }
  #section-{{ section.id }} .embla__container { display:flex; gap:1.5rem; touch-action: pan-y pinch-zoom; transition: transform 0.3s cubic-bezier(0.645, 0.045, 0.355, 1); }
  #section-{{ section.id }} .embla__container.is-dragging { transition: none; }
    #section-{{ section.id }} .card { background:#fff; border-radius: 14px; box-shadow: 0 4px 16px rgba(0,0,0,.08); padding:1rem; flex: 0 0 calc(33% - 1rem); display:flex; flex-direction:column; position:relative; transition: box-shadow .25s ease, transform .25s ease; cursor: grab; user-select: none; }
    #section-{{ section.id }} .embla__container.is-dragging .card { cursor: grabbing; transform: scale(0.98); }
    #section-{{ section.id }} .embla__container:not(.is-dragging) .card:hover { box-shadow: 0 8px 24px rgba(0,0,0,.14); transform: translateY(-4px); }
    #section-{{ section.id }} .card-image-wrapper { display:block; position:relative; margin-bottom: 0.75rem; }
    
    {% comment %} Default aspect ratio (4:3) {% endcomment %}
    {% if section.settings.video_aspect_ratio == 'shorts' %}
      #section-{{ section.id }} .card-image-wrapper img { width:100%; aspect-ratio: 9/16; object-fit:cover; border-radius:10px; }
      #section-{{ section.id }} .placeholder.small { width:100%; aspect-ratio: 9/16; display:flex; align-items:center; justify-content:center; background:#f3f3f3; border-radius:10px; }
    {% elsif section.settings.video_aspect_ratio == 'youtube' %}
      #section-{{ section.id }} .card-image-wrapper img { width:100%; aspect-ratio: 16/9; object-fit:cover; border-radius:10px; }
      #section-{{ section.id }} .placeholder.small { width:100%; aspect-ratio: 16/9; display:flex; align-items:center; justify-content:center; background:#f3f3f3; border-radius:10px; }
    {% else %}
      #section-{{ section.id }} .card-image-wrapper img { width:100%; height: clamp(220px, 30vw, 270px); object-fit:cover; border-radius:10px; }
      #section-{{ section.id }} .placeholder.small { width:100%; height: clamp(220px, 30vw, 270px); display:flex; align-items:center; justify-content:center; background:#f3f3f3; border-radius:10px; }
    {% endif %}
    #section-{{ section.id }} .card-info { flex:1; display:flex; flex-direction:column; }
    #section-{{ section.id }} .vendor { font-weight:600; letter-spacing:.15em; color:#6b7280; margin:0 0 0.15rem; text-transform:uppercase; }
    #section-{{ section.id }} .title { margin:0; line-height:1.3; }
    #section-{{ section.id }} .title a { text-decoration:none; color:#111; }
    #section-{{ section.id }} .price-wrapper { margin-top:0.4rem; }
    #section-{{ section.id }} .add-form { margin-top:0.75rem; }
    #section-{{ section.id }} .add-btn { background:#000; color:#fff; width:100%; padding:0.65rem 1rem; border:none; border-radius: 40px; font-weight:600; cursor:pointer; opacity:0; transform: translateY(4px); transition: opacity .3s ease, transform .3s ease; }
    #section-{{ section.id }} .card:hover .add-btn, #section-{{ section.id }} .add-btn:focus-visible { opacity:1; transform: translateY(0); }
    #section-{{ section.id }} .sold-out { font-weight:600; text-transform:uppercase; color:#d00; margin-top:0.75rem; }
    #section-{{ section.id }} .nav { position:absolute; top:50%; transform: translateY(-50%); background: rgba(255,255,255,0.85); backdrop-filter: blur(4px); border:none; width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; cursor:pointer; box-shadow:0 4px 12px rgba(0,0,0,.15); transition: background .25s ease; }
    #section-{{ section.id }} .nav:hover { background:#fff; }
    #section-{{ section.id }} .nav.prev { left: -18px; }
    #section-{{ section.id }} .nav.next { right: -18px; }

    @media (max-width: 1024px) {
      #section-{{ section.id }} .layout { flex-direction:column; }
      #section-{{ section.id }} .side-image-wrapper { flex: none; width:100%; }
      #section-{{ section.id }} .card { flex: 0 0 calc(70% - 1rem); }
      #section-{{ section.id }} .nav.prev { left: 4px; }
      #section-{{ section.id }} .nav.next { right: 4px; }
    }

    @media (max-width: 640px) {
      #section-{{ section.id }} .card { flex: 0 0 calc(85% - 1rem); }
      #section-{{ section.id }} .add-btn { opacity:1; transform:none; }
    }
  </style>


  {% schema %}
  {
    "name": "Side Image Carousel",
    "tag": "section",
    "class": "section side-image-product-carousel-section",
    "settings": [
      { "type": "text", "id": "heading", "label": "Heading", "default": "NEW SKIN & HAIR CARE PRODUCTS" },
      { "type": "image_picker", "id": "side_image", "label": "Side image" },
      { "type": "range", "id": "padding_vertical_percent", "label": "Vertical padding (%)", "min": 0, "max": 15, "step": 1, "default": 6 },
      { "type": "range", "id": "image_width_percent", "label": "Image width (%)", "min": 20, "max": 60, "step": 1, "default": 33 },
  { "type": "range", "id": "carousel_overlap_x", "label": "Carousel horizontal overlap (px)", "min": 0, "max": 200, "step": 5, "default": 0 },
  { "type": "range", "id": "carousel_overlap_y", "label": "Carousel vertical offset (px)", "min": -150, "max": 150, "step": 5, "default": 0 },
      { "type": "checkbox", "id": "show_vendor", "label": "Show vendor", "default": false },
      { "type": "text", "id": "add_to_cart_label", "label": "Add to cart label", "default": "Add to Cart" },
      { "type": "text", "id": "sold_out_label", "label": "Sold out label", "default": "Sold Out" },
      { "type": "color", "id": "background_color", "label": "Background color", "default": "#F8F5F2" },
      { "type": "range", "id": "scroll_cards", "label": "Cards to scroll per click", "min": 1, "max": 4, "step": 1, "default": 2 },
      {
        "type": "select",
        "id": "video_aspect_ratio",
        "label": "Video aspect ratio",
        "options": [
          { "value": "default", "label": "Default (4:3)" },
          { "value": "shorts", "label": "Shorts Video (9:16)" },
          { "value": "youtube", "label": "YouTube Video (16:9)" }
        ],
        "default": "default"
      },
      { "type": "header", "content": "Products" }
    ],
    "blocks": [
      {
        "type": "product",
        "name": "Product",
        "settings": [
          { "type": "product", "id": "product", "label": "Product" }
        ]
      }
    ],
    "max_blocks": 12,
    "presets": [
      { "name": "Side Image Carousel", "category": "Custom" }
    ]
  }
  {% endschema %}
</section>
